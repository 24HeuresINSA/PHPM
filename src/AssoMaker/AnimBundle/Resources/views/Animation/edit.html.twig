{% extends "AssoMakerBaseBundle::layout.html.twig"  %}

{% block content %}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAZDxtSjmKe1AsGme00GmrIsRCd2e1IxMw&sensor=false"></script>
<script>
  var map;
  function initialize() {
	var latlng = new google.maps.LatLng($("#assomaker_animbundle_animationtype_entity_locX")[0].value,$("#assomaker_animbundle_animationtype_entity_locY")[0].value);
    var mapOptions = {
      zoom: 17,
      mapTypeControl: false,
	  zoomControl: true,
	  streetViewControl: false,
	  panControl: false,
      center: latlng,
      scrollwheel: false,
	  mapTypeId: google.maps.MapTypeId.SATELLITE
    };
    map = new google.maps.Map(document.getElementById('map_canvas'),
        mapOptions);

    google.maps.event.addListener(map, 'center_changed', function() {
    	$("#assomaker_animbundle_animationtype_entity_locX")[0].value = map.getCenter().lat();
    	$("#assomaker_animbundle_animationtype_entity_locY")[0].value = map.getCenter().lng();
	});
	var marker = new google.maps.Marker({
		map: map, icon: new google.maps.MarkerImage('{{ asset('bundles/assomakeranim/images/cross.png') }}', undefined, undefined, new google.maps.Point(20,20))
	});
	marker.bindTo('position', map, 'center'); 

	var reset =  function() {
		 map.setCenter(new google.maps.LatLng(45.783562,4.876239));	
  }

	  
  }

  
  google.maps.event.addDomListener(window, 'load', initialize);
</script>
<script type="text/javascript">

function Ctrl($scope){

	{% if entity.horaires != 'null' %}
	$scope.horaires = {{ entity.horaires | raw}};
	{% else %}
	$scope.horaires = [];
	{% endif %}
	
	$scope.addHoraire = function(){
		$scope.horaires.push({"jour":"Samedi","debut":"10h00","fin":"18h00"});
		}

	$scope.remHoraire = function(index){
		$scope.horaires.splice(index,1);
		}

	

	
	
	{% if entity.public %}
	$scope.pub=true;
	{% endif %}

	{% if entity.extPresent %}
	$scope.extPresent=true;
	{% endif %}

	{% if entity.besoinSecu %}
    $scope.besoinSecu=true;
	{% endif %}

	{% if entity.besoinSigna %}
    $scope.besoinSigna=true;
	{% endif %}
}
</script>

<form class="form-inline" action="{{ path('anim_animation_edit',{"id":entity.id}) }}" method="post" {{ form_enctype(form) }} >
    <div class="row-fluid" ng-app ng-controller="Ctrl">

        <div class="span7">
    		<fieldset>
                
                   
                    <legend class="statut{{entity.statut }}"> Animation {{ entity.nom }} - Infos Générales</legend>
                        <div class="row-fluid">
                            <div class="span8">{{ form_row(form.entity.nom,{'attr':{'class':'input-block-level'}}) }}</div>                            
                            <div class="span4">{{ form_row(form.entity.type,{'attr':{'class':'input-block-level'}}) }}</div>
                        </div>
                        <div class="row-fluid">
                            <div class="span4">{{ form_row(form.entity.equipe,{'attr':{'class':'input-block-level'}}) }}</div>
                            <div class="span4">{{ form_row(form.entity.responsable,{'attr':{'class':'input-block-level'}}) }}</div>
                            <div class="span4">{{ form_row(form.entity.orgaManif,{'attr':{'class':'input-block-level'}}) }}</div>
                        </div>

            
            </fieldset>
            <fieldset>
                
                    
                    <legend>Infos Publiques</legend>
                    
                        <div class="row-fluid">
                            <div class="span5">{{ form_row(form.entity.public,{'attr':{'ng-model':'pub'}} ) }}</div>
                            <div class="span3" ng-show="pub">{{ form_row(form.entity.animPhare) }}</div>
                            <div class="span4" ng-show="pub">{{ form_row(form.entity.animGosses) }}</div>
                        </div>
                        <div class="row-fluid" ng-show="pub">
                            <div class="span12">{{ form_row(form.entity.description) }}</div>
                        </div>
            
            </fieldset>
            <fieldset>             
                <legend>Sécurité</legend>
                    <div class="row-fluid">
                        <div class="span6">{{ form_row(form.entity.besoinSecu,{'attr':{'ng-model':'besoinSecu'}} ) }}</div>
                        <div class="span6">{{ form_row(form.entity.besoinPass,{'attr':{'ng-model':'besoinPass'}} ) }}</div>
                    </div>
                    <div class="row-fluid" ng-show="besoinSecu">
                        {{ form_row(form.entity.detailSecu) }}
                    </div>
                    <div class="row-fluid" ng-show="besoinPass">
                        <h5>Pass Voiture</h5>
                        <p>État : Pas de pass <a class="btn btn-small" ng-click="addHoraire()"><i class="icon-refresh"></i> Générer</a></p>
                        
                    </div>          
            </fieldset>
            <fieldset>             
                <legend>Logistique</legend>
                    <div class="row-fluid">
                    </div>            
            </fieldset>
            <fieldset>             
                <legend>Signalétique</legend>
                    <div class="row-fluid">
                        {{ form_row(form.entity.besoinSigna,{'attr':{'ng-model':'besoinSigna'}} ) }}
                    </div>
                    <div class="row-fluid" ng-show="besoinSigna">
                        {{ form_row(form.entity.detailSigna) }}
                    </div>             
            </fieldset>
           
            
        
        
            
            	        
        </div>
        <div class="span5">
           <div class="row-fluid">
             <fieldset>
                <legend>Emplacement</legend>
                    <div class="row-fluid">                        
                        {{ form_row(form.entity.lieu,{'attr':{'data-provide':'typeahead','data-source':listeLieux,'autocomplete':'off'}}) }}
                        <datalist id="lieux">
                            {% for anim in listeLieux %}
                              <option value="{{ anim.lieu }}">
                            {% endfor %}
                        </datalist>                        
                    </div>
                    <div class="row-fluid">
                        <div class="span12">
                        <div id="map_canvas" class="span12" style="height:200px">
                        </div>
                        </div>
                    </div>            
              </fieldset>
            </div>
        
        
        <div class="row-fluid">
            <fieldset>
                <legend>Intervenant Extérieur</legend>
                <div class="row-fluid">
                    <div class="span8">{{ form_row(form.entity.extNom,{'attr':{'class':'input-block-level'}}) }}</div>
                    <div class="span4">{{ form_row(form.entity.extType,{'attr':{'class':'input-medium'}}) }}</div>
                </div>
                <div class="row-fluid">
                    <div class="span6">{{ form_row(form.entity.extTelephone,{'attr':{'class':'input-medium'}}) }}</div>
                    <div class="span6">{{ form_row(form.entity.extEmail) }}</div>
                </div>
            
            <div class="row-fluid">
                <div class="span12">{{ form_row(form.entity.extCommentaire) }}</div>
            </div>
            <div class="row-fluid">
                <div class="span3">{{ form_row(form.entity.extPresent,{'attr':{'ng-model':'extPresent'}}) }}</div>
                <div class="span3" ng-show="extPresent">{{ form_row(form.entity.extBoisson) }}</div>
                <div class="span3" ng-show="extPresent">{{ form_row(form.entity.extBouffe) }}</div>
                <div class="span3" ng-show="extPresent">{{ form_row(form.entity.extCatering) }}</div>
            </div>
            </fieldset>
            </div>
            <div class="row-fluid">
            <fieldset>
                <legend>Horaires <a class="btn btn-success btn-small" ng-click="addHoraire()"><i class="icon-plus"></i></a></legend>
                <div class="row-fluid">
                 <ul>
                    <li ng-repeat="h in horaires">   
                          <select class="input-medium" name="assomaker_animbundle_animationtype[entity][horaires][{%raw%}{{$index}}{% endraw %}][jour]" ng-model="h.jour">
                              <option>Jeudi</option>
                              <option>Vendredi</option>
                              <option>Samedi</option>
                              <option>Dimanche</option>                              
                          </select>
                          <select class="input-small" name="assomaker_animbundle_animationtype[entity][horaires][{%raw%}{{$index}}{% endraw %}][debut]" ng-model="h.debut">
                            {% for i in 7..23 %}
                                {% for j in ['00','15', '30', '45'] %}
                                    <option>{{ i~'h'~j }}</option>
                                {% endfor %}
                            {% endfor %}
                            {% for i in 0..6 %}
                                {% for j in ['00','15', '30', '45'] %}
                                    <option>{{ i~'h'~j }}</option>
                                {% endfor %}
                            {% endfor %}
                          </select>
                          <i class="icon-arrow-right"></i>
                           <select class="input-small" name="assomaker_animbundle_animationtype[entity][horaires][{%raw%}{{$index}}{% endraw %}][fin]" ng-model="h.fin">
                            {% for i in 18..23 %}
                                {% for j in ['00','15', '30', '45'] %}
                                    <option>{{ i~'h'~j }}</option>
                                {% endfor %}
                            {% endfor %}
                            {% for i in 0..17 %}
                                {% for j in ['00','15', '30', '45'] %}
                                    <option>{{ i~'h'~j }}</option>
                                {% endfor %}
                            {% endfor %}
                          </select>
                          
                          <a class="btn btn-small btn-danger" ng-click="remHoraire($index)"><i class="icon-remove"></i></a>
                    </li>
                    
                    
                  </ul>
                </div>
                
                
            
            
            </fieldset>
            </div>

        </div>
        
        {{ form_widget(form.entity.locX) }}
        {{ form_widget(form.entity.locY) }}
        {{ form_widget(form._token) }}
    </div>
    <div class=row-fluid>
        <fieldset>             
            <legend>Commentaires</legend>
                <div class="row-fluid">
                <ul>
                {% for c in entity.commentaires%}
                <li>{{ c.auteur }} {{ c.date | format_datetime }}: {{ c.texte | raw}}</li>
                {% endfor %}
                </ul>
                </div> 
                <div class="row-fluid">
                    {{ form_row(form.commentaire) }}
                </div>               
        </fieldset>
    </div>	
    
    <div class="form-fluid">
			<div class="form-actions">
			    <button class="btn btn-primary" type="submit" name="action" value="save">Enregistrer les modifications</button>
	            {% if entity.statut == 0 %}
		            <button class="btn btn-success" type="submit" name="action" value="submit_validation"><i class="icon-eye-open"></i> Demander la validation</button>
		        {% endif %}
		        {% if is_granted('ROLE_ADMIN') %}
		        	{% if entity.statut == 1 %}
		                <button class="btn btn-success" type="submit" name="action" value="validate"><i class="icon-ok"></i> Valider la tâche</button>
		            {% endif %}
		            {% if entity.statut >= 1  %}
		                 <button class="btn btn-warning" type="submit" name="action" value="reject"><i class="icon-remove"></i> Rejeter la tâche</button>
		            {% endif %}
		        {% endif %}
		        {% if entity.statut != -1  %}
		        	<button class="btn btn-danger" type="submit" name="action" value="delete"><i class="icon-remove"></i> Supprimer la tâche</button>
		        {% endif %}
		        {% if entity.statut == -1 %}
		        	<button class="btn btn-inverse" type="submit" name="action" value="restore">Restaurer la fiche</button>
		     	{% endif %}
			</div>
    </div>       
</form>
{% endblock %}