{% extends "AssoMakerBaseBundle::layout.html.twig"  %}
{% set pageTitle = 'Liste des Comptes Perso' %}

{% block content %}
<script>
function Ctrl($scope, $http) {

	$scope.ModeEnum = {
		    CONSOS : 0,
		    ADDSUB : 1
		}

	$scope.fetch=function($scope, $http) {
		$http.get('comptes.json').success(function(data) {
		    $scope.orgas = data;
		  });
		}

	$scope.totalCP = function() {
		var count = 0;
	    angular.forEach($scope.orgas, function(orga) {
	      count += orga.balance ;
	    });
	    return count;
	  };

	$scope.newBalance=function($key) {
		$orga = $scope.orgas[$key]
		if($scope.mode==$scope.ModeEnum.CONSOS){
			return $orga.balance - $scope.alter[$orga.id]*$scope.prixConso;
		}
		else if($scope.mode==$scope.ModeEnum.ADDSUB){
			return $orga.balance + $scope.alter[$orga.id]*1;
		}

		}

	$scope.newTotalCP = function() {
		var count = 0;
	    angular.forEach($scope.orgas, function(orga,key) {
		    if(!isNaN($scope.newBalance(key))){
	      count += $scope.newBalance(key) ;
		    }else{
		   count += orga.balance ;
			    }
	    });
	    
	    return count;
	  };

	$scope.post=function() {

		var data={ 'mode': $scope.mode, 'alter': $scope.alter, 'operation': $scope.operation};
		$http.post('process',JSON.stringify(data)).success(function(data) {
			$scope.fetch($scope,$http);
			$scope.alter=new Array();
			$scope.operation='';
		  });
		}

	$scope.prixConso={{ prixConsoStandard }};
	$scope.fetch($scope,$http);
	$scope.mode = $scope.ModeEnum.CONSOS;
	$scope.alter=new Array();
	
	}




</script>
<form class="form-horizontal" action="{{ path('comptesPerso') }}" method="post" {{ form_enctype(form) }} ng-controller="Ctrl" >
	{% raw %}
    	<div class="row-fluid">
    		<h2>Gestion des Comptes Perso</h2>
    		<div class="btn-toolbar">
        		<div class="btn-group">
                  <a ng-click="mode=ModeEnum.CONSOS" class="btn" ng:class="{true:'active', false:''}[mode==ModeEnum.CONSOS]" >Consommations Standard à {{ prixConso | number:2}}€</a>
                  <a ng-click="mode=ModeEnum.ADDSUB" class="btn" ng:class="{true:'active', false:''}[mode==ModeEnum.ADDSUB]" >Ajouter/Retirer de l'argent</a>
                </div>
                <div class="btn-group">
                  <a href="{% endraw %}{{ path('comptesPersoPrint') }}{% raw %}" class="btn" target="_blank" ><i class="icon-print"></i> Imprimer</a>
                </div>
            </div>

            <div ng:show="mode==ModeEnum.ADDSUB">
            <label>Libellé de l'opération</label>
            <input ng-model="operation" type="text" placeholder="Remise d'espèces...">
            </div>
    	</div>
    	<div class="row-fluid">
    		<table class="table table-condensed table-striped">
    		    <thead>
    		        <tr>
    		        	<th>Orga</th>
    		            <th>Solde</th>
    		            <th ng-show="mode==ModeEnum.CONSOS">Nombre de Consommations</th>
    		            <th ng-show="mode==ModeEnum.ADDSUB" >Ajouter/retirer</th>
    		            <th>Nouveau Solde</th>
    	
    		        </tr>
    		    </thead>
    		    <tbody>
    		       
    		        <tr ng-repeat="(key,orga) in orgas">
    		        	<td>{{ orga.name }}</td>
    		            <td>{{ orga.balance  | number:2}}€</td>
    		            <td><input type="number" ng-model="alter[orga.id]" ></td>
    		            <td>{{ newBalance(key)  | number:2}}€</td>
    	
    		        </tr>
    		        
    		    </tbody>
    		   	<tfoot>
    		        <tr>
    		        	<th>Total des Comptes Perso</th>
    		            <th>{{ totalCP() | number:2}}€</th>
    		            <th></th>
    		            <th>{{ newTotalCP() | number:2}}€</th>
    		        </tr>
    		   </tfoot>
    		</table>
    	</div>
    {% endraw %}
	<div class="form-actions row-fluid">
	     <a href="" ng-click="post()" class="btn btn-primary">Enregistrer les modifications</a>
	</div>
	{{ form_widget(form._token) }}
</form>
{% endblock %}

{% block actions %}
{% endblock %}


