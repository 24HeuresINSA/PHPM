<?php

namespace PHPM\Bundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * TacheRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class TacheRepository extends EntityRepository
{
	
	public function getTacheWithCriteria($duree, $permis, $niveau_confiance, $plage, $bloc)
	{
		$dql = "SELECT t FROM PHPMBundle:Tache t JOIN t.plagesHoraire p JOIN p.creneaux c WHERE c.disponibilite IS NULL";
	
		if ($duree != '') {
			$dql.= " AND ((c.fin - c.debut) < '$duree' )";
		}
// 		if($categorie !='')
// 		{
// 			$andx->add($qb->expr()->eq('t.categorie_id',$categorie));
// 		}
		if ($permis != '') {
			$dql.= " AND t.permisNecessaire >= '$permis'";
		}
// 		if($age !='')
// 		{
// 			$andx->add($qb->expr()->gte('t.ageNecessaire',$age));
// 		}
		if ($niveau_confiance != '') {
			$dql.= " AND t.confiance_id >= '$niveau_confiance'";
		}
		if ($plage != '') {
		    $pref = json_decode($this->getEntityManager()->getRepository('PHPMBundle:Config')->findOneByField('manifestation_plages')->getValue(),TRUE);
		    $plage= $pref[$plage];
		    $debut = $plage['debut'];
		    $fin = $plage['fin'];
		    $dql.= " AND (c.debut <= '$fin') AND (c.fin >='$debut') ";
		}
		
		$query = $this->getEntityManager()->createQuery($dql);
		
		return $query->getResult();
	}
	
	public function search($s)
	{
		return $this->getEntityManager()
		->createQuery("SELECT t FROM PHPMBundle:Tache t WHERE t.nom LIKE :s")
		->setParameter('s', "%".$s."%")
		->getResult();
	}
	
	public function getNonDeletedTaches($gid)
	{
	    return $this->getEntityManager()
	    ->createQuery('SELECT t FROM PHPMBundle:Tache t LEFT JOIN t.groupeTache g WHERE g.id = :gid AND t.statut !=-1')
	    ->setParameter('gid', $gid)
	    ->getResult();
	}
	

	
	
}