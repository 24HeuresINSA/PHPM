<?php

namespace PHPM\Bundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * TacheRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class TacheRepository extends EntityRepository
{
	
	public function getTacheWithCriteria($duree, $permis, $niveau_confiance, $plage, $bloc)
	{
		$dql= "Select t From PHPMBundle:Creneau ct Join ct.plageHoraire p Join p.tache t Where 1";
	
		if($duree!='')
		{
			$dql.= " AND (ct.fin - ct.debut < '$duree' )";
		}
// 		if($categorie !='')
// 		{
// 			$andx->add($qb->expr()->eq('t.categorie_id',$categorie));
// 		}
		if($permis!='')
		{
			$dql.= " AND t.permisNecessaire >= '$permis'";
		}
// 		if($age !='')
// 		{
// 			$andx->add($qb->expr()->gte('t.ageNecessaire',$age));
// 		}
		if($niveau_confiance !='')
		{
			$dql.= " AND t.confiance_id >= '$niveau_confiance'";
		}
		if($plage !='')
		{
			$dql.= " AND ct.disponibilite != 0";
			$dql.= " AND p.id = '$plage'";
		}
		
		//exit(var_dump($qb->getQuery()->getDQL()));
		
		$query = $this->getEntityManager()->createQuery($dql);
		
		return $query->getResult();
	}
	
	public function search($s)
	{
		return $this->getEntityManager()
		->createQuery("SELECT t FROM PHPMBundle:Tache t WHERE t.nom LIKE :s")
		->setParameter('s', "%".$s."%")
		->getResult();
	}
	
	public function getNonDeletedTaches($gid)
	{
	    return $this->getEntityManager()
	    ->createQuery('SELECT t FROM PHPMBundle:Tache t LEFT JOIN t.groupeTache g WHERE g.id = :gid AND t.statut !=-1')
	    ->setParameter('gid', $gid)
	    ->getResult();
	}
	

	
	
}