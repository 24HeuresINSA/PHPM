<?php

namespace PHPM\Bundle\Entity;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Query\ResultSetMapping;


/**
 * CreneauRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CreneauRepository extends EntityRepository
{
	
	public function getCreneauxParJour($orga)
	{
	
		$entities= $this->getEntityManager()
		->createQuery("
		SELECT c FROM PHPMBundle:Creneau c
		JOIN c.disponibilite d
		JOIN d.orga o
		WHERE d.orga = :orga_id
		 ")
		 ->setParameter('orga_id', $orga->getId())
		->getResult();
		 
		
		
		$result=array();
		foreach ($entities as $entity){
			$dow = $entity->getDebut()->format('w');
			
			$result[$dow][$entity->getId()] = $entity;
		
		}
		
		
		return $result;
		
	}
	
	
	public function getCreneauxParJour2($orga_id){
		$conn = $this->_em->getConnection();
		//$orga_id=$orga->getId();
	
		$sql = "SELECT c.id, WEEKDAY(c.debut) d FROM Creneau c LEFT JOIN Disponibilite d ON c.disponibilite_id=d.id LEFT JOIN Orga o ON d.orga_id=o.id ";
	
		$rows = $conn->fetchAll($sql);
		
		foreach ($rows as $row){
			var_dump($c);
			$co=$c[0];
				
			$a[$c['w']][$co->getId()]=$co;
			//$a[$c['w'][($c[0])->getId()]]=$c;
				
		}
		
		//$rows = $conn->prepare($sql)->execute();
	
	
		return $rows;
	}
	
	public function getCreneauxParJourNative($orga_id){
		
		
		$rsm = new ResultSetMapping;
		$rsm->addEntityResult('PHPM\Bundle\Entity\Creneau', 'c');
		$rsm->addFieldResult('c', 'id', 'id');
		$rsm->addFieldResult('c', 'debut', 'debut');
		$rsm->addFieldResult('c', 'fin', 'fin');
		$rsm->addFieldResult('c', 'id', 'id');
		$rsm->addJoinedEntityResult("PHPM\Bundle\Entity\PlageHoraire", "p", "c", "plageHoraire");
		
		
		$rsm->addScalarResult('d', 'd');
		
		
		$query = $this->_em->createNativeQuery(
		'SELECT c.*, p.id as p_id, WEEKDAY(c.debut) d 
		FROM Creneau c 
		LEFT JOIN PlageHoraire p ON c.plageHoraire_id=p.id
		ORDER BY d', $rsm);
		
		
		$creneaux = $query->getResult();
		var_dump($creneaux);
		exit();
		
		foreach ($creneaux as $c){
			var_dump($c);
			$co=$c[0];
			
			$a[$c['w']][$co->getId()]=$co;
			//$a[$c['w'][($c[0])->getId()]]=$c;
			
		}
		var_dump($a);
		exit();
		
		return $a;
		
		
		
		
	}
	
	public function getCreneauxCompatibleWithCriteria($niveau_confiance, $permis, $duree, $orga, $plage, $jour, $date_time, $bloc)
	{
	    $dql = 'SELECT c FROM PHPMBundle:Creneau c JOIN c.plageHoraire p JOIN p.tache t JOIN t.confiance conf WHERE c.disponibilite IS NULL ';
	
	    if ($permis != '') {
	    	$dql.= "AND t.permisNecessaire = $permis ";
		}
	    
// 	    if ($age != '') {
// 	    	$dql.= "AND t.ageNecessaire >= $age ";
// 	    }
	   
	    if ($niveau_confiance != '') {
	    	$dql.= "AND conf.valeur >= $niveau_confiance ";
		}
	       
// 	    if ($categorie != '') {
// 	    	$dql.= "AND t.categorie = $categorie ";
// 	    }

		// A TESTER
		/*
 	    if ($duree !='') {
 	    	$dql.= 'AND (DATE_DIFF(c.debut, c.fin) <= '.($duree/3600/24).' ) '; // DATE_DIFF en jour
		}*/
	    
	    if ($plage != '') {
		    $pref = json_decode($this->getEntityManager()->getRepository('PHPMBundle:Config')->findOneByField('manifestation_plages')->getValue(),TRUE);
		    $plage= $pref[$plage];
		    $debut = $plage['debut'];
		    $fin = $plage['fin'];
		    $dql.= "AND (c.debut <= '$fin') AND (c.fin >='$debut') ";
	    }
	    
		if ($jour != '') {
			// $jour est automatiquement transformé en "$jour 00:00:00"
			// DQL n'implémente pas correctement DATE() (merci Doctrine de merde), 
			// on regarde donc par rapport à l'intervalle $jour 00:00:00 et $jour+1 00:00:00
			// on ne s'intéresse qu'à l'heure de début (question de ne pas oublier de créneaux)
			$dql.= "AND (c.debut >= '".$jour->format('Y-m-d')."' ) AND (c.debut < '".$jour->add(new \DateInterval('P1D'))->format('Y-m-d')."' ) ";
		}
		
	    if ($date_time != '') {
	    	$dql.= "AND (c.debut <= '$date_time' ) AND (c.fin >= '$date_time' ) ";
	    }
	    

	    if ($orga != '') {
		    // Conflcts With creneaux
		    $dql.="AND (c.id NOT IN 
		    (SELECT ci.id FROM PHPMBundle:Creneau ci, PHPMBundle:Orga o JOIN o.disponibilites do JOIN do.creneaux co
		    WHERE o =$orga AND ( (ci.debut < co.fin) AND (ci.fin > co.debut ) )   ))";
		    
	        // Not in Orga dispo
		    $dql.="AND (c.id IN 
		    (SELECT cin.id FROM PHPMBundle:Creneau cin, PHPMBundle:Orga oin JOIN oin.disponibilites doin
		    WHERE oin =$orga AND ( (cin.debut >= doin.debut) AND (cin.fin <= doin.fin ) )   ))";
		    
		    // Compatible with orga attributes
		    $dql.="AND (c.id IN
		    (SELECT ca.id FROM PHPMBundle:Creneau ca JOIN ca.plageHoraire pa JOIN pa.tache ta JOIN ta.confiance confca,
		    PHPMBundle:Orga oa JOIN oa.confiance confoa
	        WHERE oa =$orga AND oa.permis >= ta.permisNecessaire AND confoa.valeur >= confca.valeur
		    ))";
	    }

	    $query = $this->getEntityManager()->createQuery($dql);
		
	    return $query->getResult();
	}
	
// 	public function getCreneauxCompatibleWithCriteria($niveau_confiance, $categorie, $age, $permis, $duree, $orga, $plage, $date_time, $bloc)
// 	{
// 		$qb = $this->getEntityManager()->createQueryBuilder();
// 		$expr = $qb->expr();
		
// 		$andx = $expr->andx(

// 		$expr->eq('ct.plageHoraire', 'p'),
// 		$expr->eq('p.tache','t'),
// 		$expr->isNull('ct.disponibilite')

// 		);

// 		//$offset = $bloc*50;
// 		//$limit = 50;
		
// 		if($permis!='')
// 		{
// 			$andx->add($expr->gte('t.permisNecessaire',$permis));
// 		}
// 		if($age !='')
// 		{
// 			$andx->add($expr->gte('t.ageNecessaire','\''.$age.'\''));
// 		}
// 		if($niveau_confiance !='')
// 		{
// 			$andx->add($expr->gte('t.confiance',$niveau_confiance));
// 		}
		
// 		if($categorie !='')
// 		{
// 			$andx->add($expr->gte('t.categorie',$categorie));
// 		}
// 		if($duree !='')
// 		{
			
// 			$andx->add('(ct.fin - ct.debut < '.$duree.' )');
// 		}		
// 		if($orga !='')
// 		{
// 			$andx->add(" ct.id NOT IN (SELECT ci.id FROM PHPMBundle:Creneau ci , PHPMBundle:Creneau co, PHPMBundle:Disponibilite do
// 			WHERE (co.disponibilite= do.id AND do.orga = $orga ) AND ( (ci.debut < co.fin) AND (ci.fin > co.debut ) )
// 			OR	(((ci.debut<p.debut)OR(ci.fin > p.fin))OR((ci.debut >= p.fin)OR(ci.fin <= p.debut)))
			
// 		)");
// 		}
// 		if($plage !='')
// 		{
// 			$pref = json_decode($this->getEntityManager()->getRepository('PHPMBundle:Config')->findOneByField('manifestation.plages')->getValue(),TRUE);
// 			$plage= $pref[$plage];
// 			$andx->add('(ct.debut < \''.$plage["fin"].'\' ) AND (ct.fin >\''.$plage["debut"].'\' )');
// 		}
// 		if($date_time!='')
// 		{
// 			$andx->add(($expr->lte('ct.debut',"'$date_time'")));
// 			$andx->add(($expr->gte('ct.fin',"'$date_time'")));
// 		}
		
		
		
// 		$qb
// 		->select('ct')
		
// 		->from('PHPMBundle:PlageHoraire', 'p')
// 		->from('PHPMBundle:Tache', 't')
// 		->from('PHPMBundle:Creneau', 'ct')
		
// 		->where($andx);
		
		
		
// 		//exit(var_dump($qb->getQuery()->getDQL()));
		
		
		
// 		return $qb->getQuery()->getResult();
		
// 	}
		
	
}